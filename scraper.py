import requests, re, socket, time, concurrent.futures
from datetime import datetime

# Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§)
SOURCES = [
    "https://cccamcard.com/free-cccam-server.php",
    "https://cccamia.com/cccamfree1/",
    "https://cccam.net/freecccam",
    "https://cccam-premium.pro/free-cccam/",
    "https://raw.githubusercontent.com/yebekhe/TV-Logo/main/cccam.txt",
    "https://raw.githubusercontent.com/mueof/free-cccam/main/cccam.txt",
    "https://vipsat.net/free-cccam-server.php",
    "https://boss-cccam.com/free-cccam-server.php"
]

NCAM_HEADER = """[reader]
label                         = github:SoftCam_AutoUpdate
enable                        = 1
protocol                      = emu
device                        = https://raw.githubusercontent.com/JetCamFastCam/JetFastCamRza/main/SoftCam.Key
group                         = 1

[reader]
label                         = Emulator_Local
enable                        = 1
protocol                      = emu
device                        = emulator
group                         = 1
"""

def verify_server(line):
    line = line.strip()
    # ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙŠØ¯Ø¹Ù… Ø§Ù„ÙØªØ­Ø§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø®ØªÙ„ÙØ©)
    match = re.search(r'C:\s*([a-zA-Z0-9\-\.]+)\s+(\d+)\s+(\S+)\s+(\S+)', line, re.I)
    if not match: return None
    
    host, port, user, passwd = match.groups()
    
    # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‡ÙˆØ³ØªØ§Øª Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø© (ØªØ³Ø¨Ø¨ Ø«Ù‚Ù„ Ù„Ù„Ø¬Ù‡Ø§Ø²)
    forbidden = ['streamtveuropa', 'nassim', 'visit', 'ugeen', 'test']
    if any(f in host.lower() for f in forbidden): return None

    try:
        start = time.perf_counter()
        # ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨ÙˆØ±Øª
        with socket.create_connection((host, int(port)), timeout=1.2) as sock:
            latency = int((time.perf_counter() - start) * 1000)
            if latency < 400: # Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª ØªØ­Øª 400ms
                return (latency, host, port, user, passwd)
    except:
        return None

def run_scraper():
    print(f"ğŸ“¡ Ø¨Ø¯Ø£Øª Ø¹Ù…Ù„ÙŠØ© Ø¬Ù„Ø¨ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ù…Ù† {len(SOURCES)} Ù…ØµØ§Ø¯Ø±...")
    all_raw = []
    
    with requests.Session() as s:
        s.headers.update({'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'})
        for url in SOURCES:
            try:
                r = s.get(url, timeout=15)
                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø³Ø·Ø± C: Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ø¯Ø§Ø®Ù„ ÙƒÙˆØ¯ HTML
                matches = re.findall(r'C:\s*[a-zA-Z0-9\-\.]+\s+\d+\s+\S+\s+\S+', r.text, re.I)
                all_raw.extend(matches)
                print(f"âœ… ØªÙ… Ø³Ø­Ø¨ {len(matches)} Ø³Ø·Ø± Ù…Ù†: {url.split('/')[2]}")
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ¯Ø± {url}: {e}")

    # ØªØµÙÙŠØ© Ø§Ù„Ù…ØªÙƒØ±Ø±
    unique_list = list(set(all_raw))
    print(f"ğŸ” ÙØ­Øµ Ø¬ÙˆØ¯Ø© {len(unique_list)} Ø³ÙŠØ±ÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹...")

    # Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠÙˆØ· (Ø³Ø±Ø¹Ø© Ù‚ØµÙˆÙ‰)
    with concurrent.futures.ThreadPoolExecutor(max_workers=100) as executor:
        results = [r for r in executor.map(verify_server, unique_list) if r]

    # Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø±Ø¹ (Ping Ø£Ù‚Ù„)
    results.sort(key=lambda x: x[0])

    # 1. Ø­ÙØ¸ Ù…Ù„Ù ncam.server Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¥Ù†ÙŠØ¬Ù…Ø§
    with open("ncam.server", "w", encoding="utf-8") as f:
        f.write(f"### GENERATED BY NCAM-HUNT | {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} ###\n")
        f.write(NCAM_HEADER)
        
        for i, (lat, host, port, user, passwd) in enumerate(results[:40]): # Ø£ÙØ¶Ù„ 40 Ø³ÙŠØ±ÙØ±
            f.write(f"\n[reader]\n")
            f.write(f"label                         = Server_{i+1}_{lat}ms\n")
            f.write(f"protocol                      = cccam\n")
            f.write(f"device                        = {host},{port}\n")
            f.write(f"user                          = {user}\n")
            f.write(f"password                      = {passwd}\n")
            f.write(f"group                         = 1\n")
            f.write(f"cccversion                    = 2.3.2\n")
            f.write(f"ccckeepalive                  = 1\n")

    # 2. Ø­ÙØ¸ Ù…Ù„Ù CCcam.cfg Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
    with open("CCcam.cfg", "w", encoding="utf-8") as f:
        for lat, host, port, user, passwd in results[:40]:
            f.write(f"C: {host} {port} {user} {passwd} # Ping: {lat}ms\n")

    print(f"\nâœ¨ Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!")
    print(f"ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©: ncam.server (Ù„Ù€ Ncam/Oscam) Ùˆ CCcam.cfg (Ù„Ù€ CCcam)")
    print(f"ğŸš€ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(results)} Ø³ÙŠØ±ÙØ± Ø´ØºØ§Ù„.")

if __name__ == "__main__":
    run_scraper()
