import requests
import re
import socket
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor

# Ø§Ù„Ù…ØµØ§Ø¯Ø± ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ø¯ÙŠØ§Ù„Ùƒ
SOURCES = [
    "https://cccamcard.com/free-cccam-server.php",
    "https://testcline.com/free-cccam-server.php",
    "https://cccam.premium.pro/free-cccam/",
    "https://cccamia.com/free-cccam/",
    "https://www.cccambird.com/freecccam.php",
    "https://cccamprime.com/cccam48h.php",
    "https://dhoom.org/test/",
    "https://raw.githubusercontent.com/Badr-cx/icone-wegoo/refs/heads/main/CCcam.cfg"
]

def server_tester(line):
    line = re.sub(r'<[^>]*>', '', line).strip()
    match = re.search(r'([CN]:\s*\S+\s+\d+\s+\S+\s+\S+)', line)
    if not match: return None
    
    clean_line = match.group(1)
    try:
        parts = clean_line.split()
        host, port = parts[1], int(parts[2].replace(',', ''))
        # ÙØ­Øµ ØµØ§Ø±Ù… (0.7 Ø«Ø§Ù†ÙŠØ©) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©
        with socket.create_connection((host, port), timeout=0.7):
            return clean_line
    except:
        return None

def main():
    # Ø¬Ù„Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
    today_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    all_raw_lines = []
    headers = {'User-Agent': 'Mozilla/5.0'}

    print(f"--- ğŸ› ï¸ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„ÙŠÙˆÙ…: {today_date} ---")
    
    for url in SOURCES:
        try:
            r = requests.get(url, headers=headers, timeout=10)
            found = re.findall(r'[CN]:\s?\S+\s\d+\s\S+\s\S+', r.text)
            all_raw_lines.extend(found)
        except: continue

    unique_lines = list(set(all_raw_lines))
    
    with ThreadPoolExecutor(max_workers=100) as executor:
        results = list(executor.map(server_tester, unique_lines))

    online_servers = [s for s in results if s]

    # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ®
    with open("CCcam.cfg", "w") as f:
        f.write(f"# ğŸ“… Last Update: {today_date}\n")
        f.write(f"# âœ… Total Online Servers: {len(online_servers)}\n")
        f.write("# ğŸ¤– Auto-generated by Gemini Tester\n\n")
        for s in online_servers:
            f.write(s + "\n")

    print(f"âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­! {len(online_servers)} Ø³ÙŠØ±ÙØ± Ø´ØºØ§Ù„.")

if __name__ == "__main__":
    main()
