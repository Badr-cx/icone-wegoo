import requests
import re
import socket
from concurrent.futures import ThreadPoolExecutor

# 1. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù„ÙŠ ØºÙ†Ø¬ÙŠØ¨Ùˆ Ù…Ù†Ù‡Ø§ (Sources)
SOURCES = [
    "https://cccamcard.com/free-cccam-server.php",
    "https://testcline.com/free-cccam-server.php",
    "https://cccam.premium.pro/free-cccam/",
    "https://cccamia.com/free-cccam/",
    "https://www.cccambird.com/freecccam.php",
    "https://cccamprime.com/cccam48h.php",
    "https://dhoom.org/test/",
    "https://raw.githubusercontent.com/Badr-cx/icone-wegoo/refs/heads/main/CCcam.cfg" # Ø§Ù„Ø±Ø§Ø¨Ø· Ø¯ÙŠØ§Ù„Ùƒ Ø­ØªÙ‰ Ù‡Ùˆ
]

def server_tester(line):
    """Ø§Ù„Ù€ Tester Ø§Ù„ØµØ§Ø±Ù…: ÙƒÙŠØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©"""
    # ØªÙ†Ù‚ÙŠØ© Ø§Ù„Ø³Ø·Ø± Ù…Ù† Ø£ÙŠ ÙƒÙˆØ¯ HTML Ø²Ø§ÛŒØ¯
    line = re.sub(r'<[^>]*>', '', line).strip()
    
    # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙÙˆØ±Ù…Ø§Øª Ø§Ù„Ø³Ø·Ø± (C: Host Port User Pass)
    match = re.search(r'([CN]:\s*\S+\s+\d+\s+\S+\s+\S+)', line)
    if not match:
        return None
    
    clean_line = match.group(1)
    try:
        parts = clean_line.split()
        host = parts[1]
        port = int(parts[2].replace(',', ''))
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Timeout Ù‚ØµÙŠØ± Ø¬Ø¯Ø§ Ù„Ù„Ø«Ø¨Ø§Øª)
        with socket.create_connection((host, port), timeout=0.7):
            return clean_line
    except:
        return None

def main():
    all_raw_lines = []
    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'}

    print("--- ğŸ› ï¸ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ø¨Ø¯Ø§Øª Ø®Ø¯Ø§Ù…Ø©: Ø¬Ø§Ø±ÙŠ Ø¬Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª ---")
    
    for url in SOURCES:
        try:
            r = requests.get(url, headers=headers, timeout=10)
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø·ÙˆØ± Ø¨Ù€ Regex Ø§Ø­ØªØ±Ø§ÙÙŠ
            found = re.findall(r'[CN]:\s?\S+\s\d+\s\S+\s\S+', r.text)
            all_raw_lines.extend(found)
            print(f"âœ… ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ù…Ù†: {url.split('/')[2]} ({len(found)} Ø³Ø·Ø±)")
        except:
            print(f"âŒ ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø¨ Ù…Ù†: {url.split('/')[2]}")

    # Ø­ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§ÙˆØ¯ÙŠÙ† Ù‚Ø¨Ù„ Ù…Ø§ Ù†Ø¨Ø¯Ø§Ùˆ Ø§Ù„ØªÙŠØ³Øª
    unique_lines = list(set(all_raw_lines))
    print(f"\nğŸ” Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {len(unique_lines)} Ø³Ø·Ø±. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµØ§Ø±Ù… (Tester)...")

    # ÙØ­Øµ 100 Ø³Ø·Ø± ÙØ¯Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø³Ø±Ø¹Ø©
    with ThreadPoolExecutor(max_workers=100) as executor:
        results = list(executor.map(server_tester, unique_lines))

    online_servers = [s for s in results if s]

    # Ø­ÙØ¸ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª "Ø§Ù„Ù‚Ø±Ø·Ø§Ø³Ø©" ÙÙ‚Ø·
    with open("CCcam.cfg", "w") as f:
        f.write("# ğŸ¤– Generated by Gemini Auto-Tester\n")
        f.write("# ğŸ“… Last Update: 2026\n\n")
        for s in online_servers:
            f.write(s + "\n")

    print(f"\n--- âœ¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ---")
    print(f"âœ… Ø¨Ù‚Ø§Ùˆ ØºÙŠØ± {len(online_servers)} Ø³ÙŠØ±ÙØ± Ù†Ø§Ø¶ÙŠÙŠÙ† Ù…Ù† Ø£ØµÙ„ {len(unique_lines)}.")
    print("ğŸš€ Ø§Ù„Ù…Ù„Ù CCcam.cfg Ø¯Ø§Ø¨Ø§ ÙˆØ§Ø¬Ø¯ ÙˆÙ†Ù‚ÙŠ ÙÙ€ GitHub.")

if __name__ == "__main__":
    main()
